name: Full CI/CD Pipeline (SonarQube + Nexus + Tomcat)

on:
  push:
    branches:
      - master

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # 1️⃣ CHECKOUT SOURCE CODE
      # ---------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------------------------------
      # 2️⃣ SETUP JDK 17
      # ---------------------------------------
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: 17

      # ---------------------------------------
      # 3️⃣ CONFIGURE MAVEN settings.xml
      # ---------------------------------------
      - name: Configure Maven settings.xml
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          ${MAVEN_SETTINGS}
          EOF
        env:
          MAVEN_SETTINGS: ${{ secrets.MAVEN_SETTINGS }}

      # ---------------------------------------
      # 4️⃣ SONARQUBE ANALYSIS
      # ---------------------------------------
      - name: SonarQube Scan
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # ---------------------------------------
      # 5️⃣ CHECK SONARQUBE QUALITY GATE
      # ---------------------------------------
      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        with:
          sonar-token: ${{ secrets.SONAR_TOKEN }}

      # ---------------------------------------
      # 6️⃣ BUILD WAR FILE
      # ---------------------------------------
      - name: Maven Package
        run: mvn -B package

      # ---------------------------------------
      # 7️⃣ DEPLOY ARTIFACT TO NEXUS
      # ---------------------------------------
      - name: Deploy to Nexus
        run: mvn deploy

      # ---------------------------------------
      # 8️⃣ SCP UPLOAD TO TOMCAT SERVER
      # ---------------------------------------
      - name: Copy WAR to Tomcat
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "target/*.war"
          target: "/opt/tomcat/webapps/"

      # ---------------------------------------
      # 9️⃣ RESTART TOMCAT SERVICE
      # ---------------------------------------
      - name: Restart Tomcat
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo systemctl restart tomcat
            sudo systemctl status tomcat --no-pager
